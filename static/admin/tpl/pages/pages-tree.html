{{define "pages-tree-directories"}}
    {{$interactive := index . "interactive"}}

    <ul>
        {{range $dir := index . "dirs"}}
            <li>
                <details {{if not (len $dir.Children)}}class="empty"{{end}}>
                    <summary>
                        {{if $interactive}}
                            <span class="shifu-pages-directory-name"
                                  hx-get="{{config.UI.Path}}/pages/directory?path={{$dir.Path}}"
                                  hx-target=".shifu-pages-page">
                                {{$dir.Name}}
                            </span>
                            <span>
                                <img src="{{config.UI.Path}}/static/icons/edit.svg"
                                     alt=""
                                     title="Bearbeiten"
                                     hx-get="{{config.UI.Path}}/pages/directory/edit?path={{$dir.Path}}"
                                     hx-target="body"
                                     hx-swap="beforeend" />
                                <img src="{{config.UI.Path}}/static/icons/add.svg"
                                     alt=""
                                     title="Unterordner hinzufügen"
                                     hx-get="{{config.UI.Path}}/pages/directory/add?path={{$dir.Path}}"
                                     hx-target="body"
                                     hx-swap="beforeend" />
                                <img src="{{config.UI.Path}}/static/icons/delete.svg"
                                     alt=""
                                     title="Ordner löschen"
                                     hx-get="{{config.UI.Path}}/pages/directory/delete?path={{$dir.Path}}"
                                     hx-target="body"
                                     hx-swap="beforeend" />
                            </span>
                        {{else}}
                            <span class="shifu-pages-directory-name shifu-pages-directory-selection" data-path="{{$dir.Path}}">
                                {{$dir.Name}}
                            </span>
                            <span></span>
                        {{end}}
                    </summary>

                    {{if len $dir.Children}}
                        {{template "pages-tree-directories" dict "dirs" $dir.Children "interactive" $interactive}}
                    {{end}}
                </details>
            </li>
        {{end}}
    </ul>
{{end}}

{{$interactive := .Data.Interactive}}
{{$selector := ".shifu-pages-directory-selection"}}

<div style="margin-bottom: 8px;">
    {{template "pages-tree-directories" dict "dirs" .Data.Directories "interactive" $interactive}}
</div>

{{if $interactive}}
    {{$selector = ".shifu-pages-directory-name"}}

    <button title="Ordner anlegen"
            hx-get="{{config.UI.Path}}/pages/add"
            hx-target="body"
            hx-swap="beforeend">
        <img src="{{config.UI.Path}}/static/icons/add.svg" alt="" />
        Ordner anlegen
    </button>
{{else}}
    <input type="hidden" name="path" value="" id="shifu-pages-directory-selection-path" />
{{end}}

<script>
    (function(){
        const input = document.getElementById("shifu-pages-directory-selection-path");
        document.querySelectorAll({{$selector}}).forEach(e => {
            e.addEventListener("click", e => {
                e.preventDefault();
                e.stopPropagation();
                document.querySelectorAll({{$selector}}).forEach(e => {
                    e.classList.remove("shifu-pages-directory-selected");
                });
                e.target.classList.add("shifu-pages-directory-selected");

                if (input) {
                    input.value = e.target.getAttribute("data-path");
                }
            });
        });
    })();
</script>
